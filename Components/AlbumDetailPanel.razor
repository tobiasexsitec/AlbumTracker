@using AlbumTracker.Models
@using AlbumTracker.Services
@inject IAlbumListService ListService
@inject IAlbumSearchService SearchService

@if (_displayAlbum is not null)
{
    <div class="album-detail-overlay" @onclick="Close">
        <div class="album-detail-panel" @onclick:stopPropagation="true">
            <button class="close-btn" @onclick="Close">&times;</button>
            <div class="album-detail-header">
                <AlbumCoverImage CssClass="album-detail-cover" Src="@_displayAlbum.CoverImageUrl" Alt="@($"{_displayAlbum.Name} cover")" />
                <div>
                    <h2>@_displayAlbum.Name</h2>
                    <p class="album-artist">@_displayAlbum.Artist</p>
                    @if (_displayAlbum.ReleaseYear.HasValue)
                    {
                        <span class="album-year">@_displayAlbum.ReleaseYear</span>
                    }
                    @if (!string.IsNullOrEmpty(_spotifyUrl))
                    {
                        <div>
                            <a href="@_spotifyUrl" target="_blank" rel="noopener noreferrer" class="spotify-link">Open in Spotify</a>
                        </div>
                    }
                </div>
            </div>

            <div class="album-detail-rating">
                <div class="rating-row">
                    <div>
                        <h4>Your Rating</h4>
                        <StarRating AlbumId="@_displayAlbum.Id" RatingChanged="OnUserRatingChanged" />
                    </div>
                    <div>
                        <h4>Average Rating</h4>
                        <AverageStarRating AlbumId="@_displayAlbum.Id" @ref="_averageStarRating" />
                    </div>
                </div>
            </div>

            <div class="album-detail-listen-history">
                <h4>Listen History</h4>
                <ListenTracker AlbumId="@_displayAlbum.Id" Album="@_displayAlbum" OnListChanged="RefreshLists" />
            </div>

            <div class="album-detail-review">
                <h4>Your Review</h4>
                <AlbumReviewEditor AlbumId="@_displayAlbum.Id" />
            </div>

            <div class="album-detail-actions">
                <h4>Add to list</h4>
                @if (_lists is not null)
                {
                    <div class="list-buttons">
                        @foreach (var list in _lists)
                        {
                            var inList = _listsContainingAlbum.Contains(list.Id);
                            <button class="btn btn-sm @(inList ? "btn-primary" : "btn-outline-primary")" @onclick="() => ToggleList(list.Id)">
                                @list.Name
                            </button>
                        }
                    </div>
                }
                @if (!string.IsNullOrEmpty(_addedMessage))
                {
                    <div class="alert alert-success mt-2">@_addedMessage</div>
                }
            </div>

            <h4>Tracklist</h4>
            @if (_loadingDetails)
            {
                <p class="text-muted">Loading tracks...</p>
            }
            else
            {
                <TrackList Tracks="_displayAlbum.Tracks" />
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Album? Album { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private Album? _displayAlbum;
    private bool _loadingDetails;
    private string? _spotifyUrl;
    private List<AlbumList>? _lists;
    private HashSet<string> _listsContainingAlbum = [];
    private string? _addedMessage;
    private AverageStarRating? _averageStarRating;

    protected override async Task OnParametersSetAsync()
    {
        if (Album is not null)
        {
            _displayAlbum = Album;
            _lists = await ListService.GetAllListsAsync();
            // Ensure the default "Latest Played" list exists
            await ListService.GetLatestPlayedListAsync();
            _lists = await ListService.GetAllListsAsync();
            _addedMessage = null;
            _spotifyUrl = null;
            UpdateListsContainingAlbum();

            if (!string.IsNullOrEmpty(Album.SpotifyAlbumId))
            {
                _loadingDetails = true;
                var result = await SearchService.GetAlbumDetailsAsync(Album.SpotifyAlbumId);
                if (result is not null)
                {
                    _displayAlbum = result.Album;
                    _spotifyUrl = result.ExternalUrl;
                }
                _loadingDetails = false;
            }
        }
        else
        {
            _displayAlbum = null;
        }
    }

    private void UpdateListsContainingAlbum()
    {
        _listsContainingAlbum = _lists?
            .Where(l => l.Entries.Any(e => e.Album.Id == _displayAlbum?.Id))
            .Select(l => l.Id)
            .ToHashSet() ?? [];
    }

    private async Task ToggleList(string listId)
    {
        if (_displayAlbum is null) return;

        var list = await ListService.GetListByIdAsync(listId);
        if (list is null) return;

        if (_listsContainingAlbum.Contains(listId))
        {
            await ListService.RemoveAlbumFromListAsync(listId, _displayAlbum.Id);
            _addedMessage = $"Removed from \"{list.Name}\"!";
        }
        else
        {
            await ListService.AddAlbumToListAsync(listId, _displayAlbum);
            _addedMessage = $"Added to \"{list.Name}\"!";
        }

        _lists = await ListService.GetAllListsAsync();
        UpdateListsContainingAlbum();
    }

    private async Task RefreshLists()
    {
        _lists = await ListService.GetAllListsAsync();
        UpdateListsContainingAlbum();
    }

    private async Task Close()
    {
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync();
    }

    private async Task OnUserRatingChanged(int _)
    {
        if (_averageStarRating is not null)
            await _averageStarRating.RefreshAsync();
    }
}
