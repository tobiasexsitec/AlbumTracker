@using Microsoft.AspNetCore.Components.Authorization
@inject AlbumTracker.Services.FirebaseAuthStateProvider AuthProvider

<AuthorizeView>
    <Authorized>
        <div class="user-menu">
            <button class="user-initials" title="@context.User.Identity?.Name" @onclick="ToggleMenu" @onclick:stopPropagation>
                @GetInitials(context.User.Identity?.Name)
            </button>
            @if (showMenu)
            {
                <div class="menu-backdrop" @onclick="CloseMenu"></div>
                <div class="user-dropdown">
                    <button class="dropdown-item" @onclick="SignOut">Sign out</button>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <button class="btn btn-sm btn-primary" @onclick="SignIn">Sign in with Google</button>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool showMenu;

    private void ToggleMenu() => showMenu = !showMenu;

    private void CloseMenu() => showMenu = false;

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant()
            : parts[0][..Math.Min(2, parts[0].Length)].ToUpperInvariant();
    }

    private async Task SignIn()
    {
        await AuthProvider.SignInWithGoogleAsync();
    }

    private async Task SignOut()
    {
        showMenu = false;
        await AuthProvider.SignOutAsync();
    }
}