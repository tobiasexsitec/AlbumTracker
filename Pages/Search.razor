@page "/search"
@using AlbumTracker.Models
@using AlbumTracker.Services
@using AlbumTracker.Components
@inject IAlbumSearchService SearchService

<PageTitle>Search Albums</PageTitle>

<h1>?? Search Albums</h1>

<div class="search-bar">
    <input type="text" class="form-control" placeholder="Search by album name or artist..."
           @bind="_query" @bind:event="oninput" @onkeydown="HandleKeyDown" />
    <button class="btn btn-primary" @onclick="PerformSearch" disabled="@_searching">
        @(_searching ? "Searching..." : "Search")
    </button>
</div>

@if (_results is not null)
{
    @if (_results.Count == 0)
    {
        <p class="mt-3">No albums found for "<strong>@_lastQuery</strong>".</p>
    }
    else
    {
        <div class="album-grid mt-3">
            @foreach (var album in _results)
            {
                <AlbumCard Album="album" Clicked="() => SelectAlbum(album)" />
            }
        </div>
    }
}

<AlbumDetailPanel Album="_selectedAlbum" OnClose="CloseDetail" />

@code {
    private string _query = string.Empty;
    private string _lastQuery = string.Empty;
    private List<Album>? _results;
    private bool _searching;
    private Album? _selectedAlbum;

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(_query)) return;
        _searching = true;
        _lastQuery = _query;
        _results = await SearchService.SearchAlbumsAsync(_query);
        _searching = false;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await PerformSearch();
    }

    private void SelectAlbum(Album album) => _selectedAlbum = album;

    private void CloseDetail() => _selectedAlbum = null;
}
